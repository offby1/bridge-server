<script>
  var es = new ReconnectingEventSource('{{ chat_event_source_endpoint }}');

  es.addEventListener('message', function (e) {
  var parsed = JSON.parse(e.data)
  var newRow = document.createElement("tr");

  var newDatum;

  newDatum = document.createElement("td");
  newDatum.append(parsed.when);
  newRow.append(newDatum);

  newDatum = document.createElement("td");
  newDatum.append(parsed.who);
  newRow.append(newDatum);

  newDatum = document.createElement("td");
  newDatum.append(parsed.what);
  newRow.append(newDatum);

  document.querySelector( "#chat-log" ).append(newRow);
  }, false);

  window.postMessage = function(message){
  fetch("{{ chat_post_endpoint }}", {
  method: "POST",
  headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
  body: JSON.stringify({message: message})
  }).then(
  (response) => {
  if (!response.ok) {
  response.text().then((text) => alert(text));
  }
  }
  );
  }
</script>
