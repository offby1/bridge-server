{% extends "base.html" %}
{% block content %}
    <div>
        <div style="display: flex">
            <div style="flex-grow: 1">
                <h1>{{ table.current_hand.board }}</h1>
            </div>
            <div>
                <h1>{{ table }}</h1>
            </div>
        </div>
        <h1>
            <div id="auction-summary">Auction: {{ table.current_auction.status }}</div>
        </h1>
        <h1>
            <div id="hand-summary">{{ table.current_hand.status }}</div>
        </h1>
    </div>
    <div class="col">
        {# North at the top as per the Bridge Writing Style Guide #}
        <div id="four-hands"
             style="border: 1px solid;
                    height: 50%;
                    font-family: monospace"
             data-table="{{ table.pk }}"
             data-hand-status="{% if table.hand_is_complete is True %}It's all over now, Baby Blue{% endif %}">
            <div class="row" style="display: grid; grid-template-columns: 1fr 1fr 1fr">
                <div class="col"></div>
                <div class="col">
                    {{ pokey_buttons.North }}{{ card_display.North.player.name_dir }}: {{ card_display.North.cards }}
                </div>
                <div class="col"></div>
            </div>
            <div class="row" style="display: grid; grid-template-columns: 1fr 1fr 1fr">
                <div class="col">{{ pokey_buttons.West }}{{ card_display.West.player.name_dir }}: {{ card_display.West.cards }}</div>
                <div class="col">
                    <div class="three-by-three-yadda-yadda">
                        {% for row in three_by_three_trick_display.rows %}
                            <div class="row" style="display: grid; grid-template-columns: 1fr 1fr 1fr">
                                {% for column in row %}
                                    <div class="col"
                                         {% if column != " " %}style="border: 1px dotted;"{% endif %}>
                                        {{ column|safe }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col">{{ pokey_buttons.East }}{{ card_display.East.player.name_dir }}: {{ card_display.East.cards }}</div>
            </div>
            <div class="row" style="display: grid; grid-template-columns: 1fr 1fr 1fr">
                <div class="col"></div>
                <div class="col">
                    {{ pokey_buttons.South }}{{ card_display.South.player.name_dir }}: {{ card_display.South.cards }}
                </div>
                <div class="col"></div>
            </div>
        </div>
    </div>
    <div style="display: flex;">
        <div>
            <div style="font-family: monospace;" id="bidding-box">
                {% if display_bidding_box %}{{ bidding_box_buttons }}{% endif %}
            </div>
        </div>
        <div style="flex-grow: 1">
            {% if show_auction_history %}
                <div id="auction" style="border: 1px dotted; overflow: auto; height: 10em">
                    <table class="table">
                        <th>
                            <tr>
                                <td>
                                    <i>West</i>
                                </td>
                                <td>
                                    <i>North</i>
                                </td>
                                <td>
                                    <i>East</i>
                                </td>
                                <td>
                                    <i>South</i>
                                </td>
                            </tr>
                        </th>
                        <tbody>
                            {% for row in table.current_auction.fancy_HTML_display %}
                                <tr>
                                    {% for call in row %}
                                        <td>
                                            {% if call is not None %}{{ call|safe }}{% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    <script>
var auctionEventSource = new ReconnectingEventSource('/events/table/{{ table.pk }}');

auctionEventSource.addEventListener('message', function (e) {
    var d = JSON.parse(e.data) ;
    // Reload the partial only if the data indicates something about the auction.
    if (("call" in d) || ("contract" in d)) {
        console.log("Auction event listener saw " + e.data);

        if ("call" in d) {
            htmx.ajax('GET', '{{ auction_partial_endpoint }}', {target:'#auction', swap:'outerHTML scroll:bottom'}).then(() => {
                console.log("Auction event listener fetched {{ auction_partial_endpoint }}");
                htmx.ajax('GET', '{{ bidding_box_partial_endpoint }}', {target:'#bidding-box', swap:'outerHTML'}).then(() => {
                    console.log("Auction event listener fetched {{ bidding_box_partial_endpoint }}" );
                });
            });
        } else if ("contract_text" in d) {
            htmx.swap ('#auction-summary', d.contract_text, {swapStyle:'innerHTML'});
        }
    }

}, false);

    </script>
    <script>
var play_event_source = new ReconnectingEventSource('/events/table/{{ table.pk }}');

play_event_source.addEventListener('message', function (e) {
    var d = JSON.parse(e.data) ;
    if ("contract" in d) {
        console.log("Opening lead event listener saw " + e.data);

        var openingLeader = d["contract"]["opening_leader"];

        if (openingLeader == {{ user.player.seat.direction }}) {
            // Ideally we'd just reload the one hand that changed, not all four; but oh well
            htmx.ajax('GET', '{{ four_hands_partial_endpoint }}', {target:'#four-hands', swap:'outerHTML'});
        }
    } else if ("card" in d) {
        // TODO: Reload the partial only if the data indicates that the viewer, or dummy's, hands have changed.
        htmx.ajax('GET', '{{ four_hands_partial_endpoint }}', {target:'#four-hands', swap:'outerHTML'}).then(() => {
            htmx.ajax('GET', '{{ hand_summary_endpoint }}', {target:'#hand-summary', swap:'innerHTML'})
            console.log(
                new Date().toISOString(),
                ": Play event listener saw play #"
                    + d.play_id
                    + ", "
                    + d.card
                    + " from "
                    + d.player
                    + ", so it fetched {{ four_hands_partial_endpoint }} and {{ hand_summary_endpoint }}"
            );
        });

    }
}, false);

htmx.on("htmx:afterSettle", function(evt) {
    var handStatusDataset = document.querySelector("#four-hands").dataset;
    if (handStatusDataset.handStatus) {
        console.log("Way-ul, our DOM has settled, and the ol' clock on the wall says " +  handStatusDataset.handStatus + ", so maybe I'll forcibly reload this page");
        auctionEventSource.close();
        play_event_source.close();
        window.location.reload();
    }
})


    </script>
    <script>
htmx.on("htmx:responseError", function(evt) {
   alert(evt.detail.xhr.response);
});
    </script>
{% endblock scripts %}
